/*! V1.3.2, Â© INA 2016 */
/**
 * Copyright (c) 2015 Institut National de l'Audiovisuel, INA
 * This file is part of amalia.js

 * amalia.js is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

 * Redistributions of source code, javascript and css minified versions
 * must retain the above copyright notice, this list of conditions and the following disclaimer.

 * Neither the name of the copyright holder nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.

 * You should have received a copy of the GNU General Public License
 * along with amalia.js. If not, see <http://www.gnu.org/licenses/>

 *
 * amalia.js is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 */

fr.ina.amalia.player.plugins.PluginBaseMultiBlocks.extend("fr.ina.amalia.player.plugins.D3JsChartPlugin",{classCss:"ajs-plugin plugin-db3-js-chart",COMPONENT_NAME:"focus-component",eventTypes:{}},{container:null,loadDataStarted:!1,dataToDeal:null,selectedItem:null,chart:null,tcin:0,tcout:0,initialize:function(){this.loadDataStarted=!0,this.selectedItem=null,this.dataToDeal=[],this.chart=null,this.tcin=0,this.tcout=0,this._super(),this.settings=$.extend({defaultColor:"#00CCCC",rightClickAction:null,framerate:"25",timeFormat:"f",timecursor:!0,colors:["#0d8bc7","#00CC99","#AE4CFF","#00FFDA","#FF654C","#18B8FF","#FF38A0","#A9FF78","#FF9500","#00C7FF","#FF1986","#D7FF19","#FFD907","#4CFFEE","#FF00AD","#82FF4C"],withFocus:!1,callbacks:[{label:"voir",callback:""}]},this.settings.parameters||{}),this.container=$("<div>",{"class":this.Class.classCss}),this.pluginContainer.append(this.container),this.registerMetadataType(),this.definePlayerListeners(),this.loaderContainer.show()},registerMetadataType:function(){this.listOfMetadataTypes=[],this.addManagedMetadataType(fr.ina.amalia.player.PluginBindingManager.dataTypes.HISTOGRAM)},definePlayerListeners:function(){var a=this.mediaPlayer.getContainer();a.one(fr.ina.amalia.player.PlayerEventType.TIME_CHANGE,$.proxy(this.onPluginReady,this)),a.on(fr.ina.amalia.player.PlayerEventType.BEGIN_DATA_CHANGE,$.proxy(this.onBeginDataChange,this)),a.on(fr.ina.amalia.player.PlayerEventType.END_DATA_CHANGE,$.proxy(this.onEndDataChange,this)),a.on(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,$.proxy(this.onDataChange,this)),this.settings.timecursor===!0&&a.on(fr.ina.amalia.player.PlayerEventType.TIME_CHANGE,$.proxy(this.onTimeupdate,this)),null!==this.logger&&this.logger.trace(this.Class.fullName,"DefinePlayerListeners")},initializeOnLoadStart:function(){this.tcin=this.mediaPlayer.getTcOffset(),this.tcout=this.tcin+this.mediaPlayer.getDuration(),this.createPluginContainer(),this.loaderContainer.hide(),this.createChart(),this.defineEventListeners()},defineEventListeners:function(){var a=this.mediaPlayer.getContainer();this.settings.withFocus===!0&&(this.container.find(".focus-container ."+this.Class.COMPONENT_NAME).resizable({handles:"w,e",containment:"parent",create:function(a){$(a.target).find("div.ui-resizable-handle").addClass("ajs-icon ajs-icon-reorder")},stop:$.proxy(this.onResizeStop,this)}),this.container.find(".focus-container ."+this.Class.COMPONENT_NAME).draggable({axis:"x",containment:"parent",stop:$.proxy(this.onDragStop,this)})),""===this.settings.metadataId&&a.on(fr.ina.amalia.player.PlayerEventType.SELECTED_METADATA_CHANGE,$.proxy(this.onSelectedMetadataChange,this))},createPluginContainer:function(){var a=$("<div>",{"class":"components ajs-margin-top"}),b=this.createComponent(this.settings.title);a.append(b),this.container.append(a)},createComponent:function(a){var b=$("<div>",{"class":"component"}),c=$("<div>",{"class":"timeline-cursor"}),d=$("<p>",{"class":"title"});d.html(a);var e=$("<div>",{"class":"module-chart"});e.append("<svg><svg/>");var f=$("<div>",{"class":"line"});if(b.append(c),b.append(d),b.append(e),b.append(f),this.settings.withFocus===!0){var g=$("<div>",{"class":"focus-container"}),h=$("<div>",{"class":this.Class.COMPONENT_NAME});g.append(h),b.append(g)}return b},createChart:function(){var a=this;nv.addGraph({generate:function(){return a.chart=nv.models.multiBarChart().staggerLabels(!0).stacked(!0).showYAxis(!1).color(a.settings.colors).controlLabels({grouped:fr.ina.amalia.player.PlayerMessage.PLUGIN_D3JS_CHART_LABELS[0],stacked:fr.ina.amalia.player.PlayerMessage.PLUGIN_D3JS_CHART_LABELS[1]}).margin({left:0,right:0,top:0,bottom:50}),a.chart.xAxis.tickFormat(function(b){return fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(b,a.settings.framerate,a.settings.timeFormat)}),a.updateChartData(),nv.utils.windowResize(a.chart.update),a.chart.multibar.dispatch.on("elementClick",$.proxy(a.onClick,a)),a.chart}})},updateChartData:function(){var a=[];for(var b in this.dataToDeal){var c=this.mediaPlayer.getBlockMetadata(this.dataToDeal[b]),d=this.dataToDeal[b].toString(),e=null!==c&&c.hasOwnProperty("label")?"-"===c.label?"":c.label:d,f=this.mediaPlayer.getMetadataById(d);this.sortListOfData(f),a.push({key:e,values:$.map(f,function(a){return{x:a.tc,y:a.score}})})}d3.select(this.container.find(".module-chart svg").get(0)).datum(a).transition().duration(500).call(this.chart)},sortListOfData:function(a){a.sort(function(a,b){return a=parseInt(a.tc),b=parseInt(b.tc),a>b?1:b>a?-1:0})},getFocusTcin:function(){var a=this.tcout-this.tcin,b=parseFloat(a*this.container.find(".focus-container ."+this.Class.COMPONENT_NAME).first().position().left/this.container.find(".focus-container").first().width());return Math.max(this.tcin,this.tcin+b)},getFocusTcout:function(){var a=this.getFocusTcin(),b=this.tcout-this.tcin,c=parseFloat(b*this.container.find(".focus-container ."+this.Class.COMPONENT_NAME).first().width()/this.container.find(".focus-container").first().width());return Math.min(this.tcout,a+c)},selectedZoneChange:function(){var a=this.getFocusTcin(),b=this.getFocusTcout(),c=this.mediaPlayer.getContainer();c.trigger(fr.ina.amalia.player.PlayerEventType.ZOOM_RANGE_CHANGE,{focusTcin:a,focusTcout:b}),null!==this.logger&&this.logger.trace(this.Class.fullName,"selectedZoneChange trigger event :  focusTcin:"+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(a,this.settings.framerate,this.settings.timeFormat)+" focusTcout:"+fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(b,this.settings.framerate,this.settings.timeFormat))},updateTimelinePos:function(a){var b=parseFloat(a),c=this.tcout-this.tcin;this.container.find(".timeline-cursor").css("left",100*(b-this.tcin)/c+"%")},onPluginReady:function(){null!==this.logger&&this.logger.trace(this.Class.fullName,"onPluginReady")},onBeginDataChange:function(){this.loadDataStarted=!0,this.dataToDeal=[],null!==this.logger&&this.logger.trace(this.Class.fullName,"onBeginDataChange")},onDataChange:function(a,b){if(this.loadDataStarted===!0){var c=this.mediaPlayer.getBlockMetadata(b.id);this.isManagedMetadataType(c.type)&&$.inArray(b.id,this.dataToDeal)<0&&this.dataToDeal.push(b.id)}else this.updateChartData()},onEndDataChange:function(){this.loadDataStarted=!1,this.initializeOnLoadStart()},onClick:function(a){this.mediaPlayer.setCurrentTime(a.data.x)},onSelectedMetadataChange:function(a,b){this._super(a,b)},onResizeStop:function(){this.selectedZoneChange(),null!==this.logger&&this.logger.trace(this.Class.fullName,"onResizeStop")},onDragStop:function(){this.selectedZoneChange(),null!==this.logger&&this.logger.trace(this.Class.fullName,"onDragStop")},onTimeupdate:function(a,b){this.updateTimelinePos(parseFloat(b.currentTime))}});