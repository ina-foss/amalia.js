/*! V1.3.3, Â© INA 2023 */
/**
 * Copyright (c) 2015-2023 Institut National de l'Audiovisuel, INA
 *
 * This file is part of amalia.js
 *
 * Amalia.js is free software: you can redistribute it and/or modify it under
 * the terms of the MIT License
 *
 * Redistributions of source code, javascript and css minified versions must
 * retain the above copyright notice, this list of conditions and the following
 * disclaimer
 *
 * Neither the name of the copyright holder nor the names of its contributors
 * may be used to endorse or promote products derived from this software without
 * specific prior written permission
 *
 * You should have received a copy of the MIT License along with
 * amalia.js. If not, see <https://opensource.org/license/mit/>
 *
 * Amalia.js is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE.
 */
fr.ina.amalia.player.BasePlayer.extend("fr.ina.amalia.player.YtPlayer",{ytPlayerContainerClassCss:"player",ytPlayerContainerStyle:"position: relative; width: inherit; height: inherit; background-color: black; ",YT_BASE_URI:"https://www.youtube.com/iframe_api"},{ytPlayerContainer:null,ytPlayer:null,lastState:null,ytTimeupdateInterval:null,initialize:function(){this.ytTimeupdateInterval=null,this.ytPlayerContainer=$("<div/>",{class:this.Class.ytPlayerContainerClassCss,style:this.Class.ytPlayerContainerStyle,id:fr.ina.amalia.player.helpers.UtilitiesHelper.generateUUID("ajs-yt-player")}),this.mediaContainer.append(this.ytPlayerContainer),this.setSrc(this.settings.src,this.settings.autoplay),this._super(),$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",{self:this},this.onFullscreenHandler)},setSrc:function(a,b){var c="object"==typeof this.settings.controlBar&&!0===this.settings.controlBar.hasOwnProperty("hide")&&!0===this.settings.controlBar.hide;this.ytPlayer=new YT.Player(this.ytPlayerContainer.attr("id"),{videoId:a,playerVars:{autoplay:b,showinfo:0,controls:!0===c?1:0,rel:0,showsearch:0,iv_load_policy:3},events:{onReady:$.proxy(this.onPlayerReady,this),onStateChange:$.proxy(this.onPlayerStateChange,this),onError:$.proxy(this.onPlayerError,this)}})},updateContainerSize:function(){if("object"==typeof this.settings.controlBar&&!0===this.settings.controlBar.hasOwnProperty("sticky")&&!0===this.settings.controlBar.sticky){var a="object"==typeof this.settings.controlBar&&!0===this.settings.controlBar.hasOwnProperty("height")&&""!==this.settings.controlBar.height?this.settings.controlBar.height:45;this.mediaContainer.find("iframe").first().css("height",this.mediaContainer.height()-a)}},onPlayerReady:function(a){if(this.hideLoader(),!!("object"==typeof this.settings.controlBar&&!0===this.settings.controlBar.hasOwnProperty("sticky")&&!0===this.settings.controlBar.sticky)){var b="object"==typeof this.settings.controlBar&&!0===this.settings.controlBar.hasOwnProperty("height")&&""!==this.settings.controlBar.height?this.settings.controlBar.height:45;this.mediaContainer.find("iframe").first().css("height",this.mediaContainer.height()-b)}a.target.setVolume(!1===this.localStorageManager.hasItem("volume")?this.settings.defaultVolume:this.localStorageManager.getItem("volume"))},onPlayerStateChange:function(a){var b=a.data;if(b!==this.lastState){if(null!==a&&a.hasOwnProperty("data")&&null!==a.data)switch(a.data){case-1:this.mediaContainer.trigger(fr.ina.amalia.player.PlayerEventType.STARTED,[this]),null!==this.logger&&this.logger.trace(this.Class.fullName+" :: PlayerState -1");break;case YT.PlayerState.ENDED:this.mediaContainer.trigger(fr.ina.amalia.player.PlayerEventType.ENDED,[this]),clearInterval(this.ytTimeupdateInterval),null!==this.logger&&this.logger.trace(this.Class.fullName+" :: PlayerState.ENDED",b);break;case YT.PlayerState.PLAYING:this.ytTimeupdateInterval=setInterval($.proxy(this.onTimeupdate,this),250),this.mediaContainer.trigger(fr.ina.amalia.player.PlayerEventType.PLAYING,[this]),this.hideLoader(),null!==this.logger&&this.logger.trace(this.Class.fullName+" :: PlayerState.PLAYING",b);break;case YT.PlayerState.PAUSED:clearInterval(this.ytTimeupdateInterval),this.mediaContainer.trigger(fr.ina.amalia.player.PlayerEventType.PAUSED,[this]),this.hideLoader(),null!==this.logger&&this.logger.trace(this.Class.fullName+" :: PlayerState.PAUSED");break;case YT.PlayerState.BUFFERING:this.showLoader(),null!==this.logger&&this.logger.trace(this.Class.fullName+" :: PlayerState.BUFFERING");break;case YT.PlayerState.CUED:this.hideLoader()}this.lastState=b}},onPlayerError:function(a){null!==this.logger&&(this.logger.warn(this.Class.fullName+" :: onPlayerError"),this.logger.warn(a)),this.mediaContainer.trigger(fr.ina.amalia.player.PlayerEventType.ERROR,{self:this,errorCode:fr.ina.amalia.player.PlayerErrorCode.MEDIA_FILE_NOT_FOUND}),this.ytPlayer.stopVideo(),this.ytPlayer.destroy(),this.ytPlayer=null},onFullscreenHandler:function(a){$(a.originalEvent.target).attr("id")===a.data.self.mediaContainer.attr("id")&&(a.data.self.updateContainerSize(),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onFullscreenHandler updateContainerSize"))},play:function(){null!==this.ytPlayer&&(this.ytPlayer.playVideo(),this._super())},pause:function(){null!==this.ytPlayer&&(this.ytPlayer.pauseVideo(),this._super())},stop:function(){null!==this.ytPlayer&&(this.ytPlayer.stopVideo(),this._super())},mute:function(){null!==this.ytPlayer&&(this.ytPlayer.mute(),this._super())},unmute:function(){null!==this.ytPlayer&&(this.ytPlayer.unMute(),this._super())},getDuration:function(){return this.ytPlayer?this.ytPlayer.getDuration():0},getVolume:function(){return null!==this.ytPlayer?this.ytPlayer.getVolume():null},setVolume:function(a){return null!==this.ytPlayer?this.ytPlayer.setVolume(a):null},getCurrentTime:function(){return null!==this.ytPlayer?this.ytPlayer.getCurrentTime()+this.tcOffset:this.tcOffset},setCurrentTime:function(a){var b=isNaN(a)?0:a;null!==this.ytPlayer&&this.ytPlayer.seekTo(Math.max(0,b-this.tcOffset),!0),this._super(b)},isPaused:function(){return null!==this.ytPlayer?this.lastState===YT.PlayerState.PAUSED:null},getPlaybackrate:function(){return null!==this.ytPlayer?this.ytPlayer.getPlaybackRate():null},setPlaybackrate:function(a){null!==this.ytPlayer&&this.ytPlayer.setPlaybackrate(a)},onTimeupdate:function(){var tcOffset=this.getTcOffset(),currentTime=this.getCurrentTime(),duration=this.getDuration()+tcOffset,percentage=100*(currentTime-tcOffset)/(duration-tcOffset);if(this.mediaContainer.trigger(fr.ina.amalia.player.PlayerEventType.TIME_CHANGE,{self:this,currentTime:currentTime,duration:duration,percentage:percentage,tcOffset:this.getTcOffset()}),!0===this.isRangePlayer&&"number"==typeof this.rangePlayerTcout&&this.rangePlayerTcout<=currentTime&&this.pause(),void 0!==this.settings.callbacks.onTimeupdate)try{eval(this.settings.callbacks.onTimeupdate+"(currentTime)")}catch(a){null!==this.logger&&this.logger.warn("Send callback failed.")}}});