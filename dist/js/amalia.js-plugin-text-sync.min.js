/*! V1.3.2, Â© INA 2016 */
/**
 * Copyright (c) 2015 Institut National de l'Audiovisuel, INA
 * This file is part of amalia.js

 * amalia.js is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

 * Redistributions of source code, javascript and css minified versions
 * must retain the above copyright notice, this list of conditions and the following disclaimer.

 * Neither the name of the copyright holder nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.

 * You should have received a copy of the GNU General Public License
 * along with amalia.js. If not, see <http://www.gnu.org/licenses/>

 *
 * amalia.js is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 */

$.Class("fr.ina.amalia.player.plugins.textSyncPlugin.Component",{ComponentClassCss:"line-component",eventTypes:{CLICK:"fr.ina.amalia.player.plugins.textSyncPlugin.Component.event.click"}},{settings:{},logger:null,mainContainer:null,tooltipConfiguration:{position:{my:"left+10 center",at:"right center",delay:3e3,using:function(a,b){$(this).css(a),$("<div>").addClass(b.vertical).addClass(b.horizontal).appendTo(this)}}},init:function(a){if(this.settings=$.extend({debug:!1,framerate:"25",container:""},a||{}),"undefined"!=typeof fr.ina.amalia.player.log&&"undefined"!=typeof fr.ina.amalia.player.log.LogHandler&&(this.logger=new fr.ina.amalia.player.log.LogHandler({enabled:this.settings.debug})),this.mainContainer=this.settings.container,0===this.mainContainer.length||"object"!=typeof this.mainContainer)throw new Error("Your container is empty.");this.initialize()},initialize:function(){null!==this.logger&&this.logger.trace(this.Class.fullName,"initialize"),this.mainContainer.addClass(this.Class.ComponentClassCss)},createLine:function(a,b,c,d,e,f){var g=$("<li>",{"class":"line media","data-tcin":a,"data-tcout":b}),h=$("<div>",{"class":"info pull-left"});e=null!==e&&"undefined"!=typeof e?'background-image:url("'+e+'");':"";var i=$("<div>",{"class":"thumb","data-tc":a,style:e});h.append(i),i.on("click",{self:this},this.onClickAtTc);var j=$("<time>",{"class":"tcin badge",title:"Tc in","data-tc":a,text:fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(a,this.settings.framerate,"s")}).tooltip(this.tooltipConfiguration).on("click",{self:this},this.onClickAtTc),k=$("<time>",{"class":"tcout badge",title:"Tc out","data-tc":b,text:fr.ina.amalia.player.helpers.UtilitiesHelper.formatTime(b,this.settings.framerate,"s")}).tooltip(this.tooltipConfiguration).on("click",{self:this},this.onClickAtTc),l=$("<div>",{"class":"ajs-progress"}).hide(),m=$("<div>",{"class":"ajs-progress-bar",style:"width:0%;"});l.append(m),h.append(j),h.append(k);var n=$("<div>",{"class":"content"});if(null!==c){var o=$("<label>",{"class":"heading",text:c});n.append(o)}this.textContainer=$("<p>",{"class":"text"}),"string"==typeof d?this.textContainer.html(d):this.textContainer.append(d),n.append(this.textContainer),n.append(l),g.append(h),g.append(n),g.data("metadata",f),this.mainContainer.append(g)},addText:function(a){null!==this.textContainer&&(this.textContainer.append(a),this.textContainer.find(".word").on("click",{self:this},this.onClickAtTc))},onClickAtTc:function(a){var b=$(a.currentTarget),c=parseFloat(b.attr("data-tc"));a.data.self.mainContainer.trigger(a.data.self.Class.eventTypes.CLICK,{tc:c}),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onClickAtCuepoint tc:"+c)}}),fr.ina.amalia.player.plugins.captions.CaptionsBase.extend("fr.ina.amalia.player.plugins.TextSyncPlugin",{classCss:"ajs-plugin plugin-text-sync",style:""},{withMainLevel:!1,karaoke:!1,loadDataStarted:!1,selectedMetadataId:"",initialize:function(){this.container=$("<ul>",{"class":"ajs-media-list"}),this.settings=$.extend({debug:this.settings.debug,framerate:"25",internalPlugin:!1,metadataId:"",level:2,title:"",description:"",displayLevel:"",autoScroll:!1,karaokeOffsetTime:1},this.settings.parameters||{}),this.settings.displayLevel=""===this.settings.displayLevel?this.settings.level:this.settings.displayLevel,this.withMainLevel=this.settings.displayLevel!==this.settings.level,this.karaoke=this.withMainLevel,""!==this.settings.title&&this.createTitleBlock(this.settings.title,this.settings.description),this.container.on(fr.ina.amalia.player.plugins.textSyncPlugin.Component.eventTypes.CLICK,{self:this},this.onClickTc),this.pluginContainer.append(this.container),this.defineEventListeners()},defineEventListeners:function(){var a=this.mediaPlayer.getContainer();a.on(fr.ina.amalia.player.PlayerEventType.BEGIN_DATA_CHANGE,{self:this},this.onBeginDataChange),a.on(fr.ina.amalia.player.PlayerEventType.DATA_CHANGE,{self:this},this.onDataChange),a.on(fr.ina.amalia.player.PlayerEventType.END_DATA_CHANGE,{self:this},this.onEndDataChange),a.on(fr.ina.amalia.player.PlayerEventType.TIME_CHANGE,{self:this},this.onTimeupdate),this.settings.autoScroll===!0&&a.on(fr.ina.amalia.player.PlayerEventType.SEEK,{self:this},this.onSeek),a.on(fr.ina.amalia.player.PlayerEventType.SELECTED_METADATA_CHANGE,{self:this},this.onSelectedMetadataChange)},updateListOfDisplayItems:function(a){var b=null,c=null;this.container.empty();for(var d=0;d<this.listOfData.length;d++)c=this.listOfData[d],c.level===a?(b=this.createComponent(this.container),null!==b?"function"==typeof b.createLine&&b.createLine(c.tcin,c.tcout,c.label,this.withMainLevel===!0?"":c.text,c.thumb,c):null!==this.logger&&this.logger.warn("Error initializing the component.")):c.level>a&&null!==b&&b.addText(this.createWord(c));this.container.height(parseInt(this.pluginContainer.height()-parseInt(this.pluginContainer.find(".header").first().height())-20)+"px")},createWord:function(a){return $("<span>",{"class":"word",text:a.text,"data-tc":a.tcin,"data-tcin":a.tcin,"data-tcout":a.tcout}).data("metadata",a)},createComponent:function(a,b){var c=null,d=$.extend({debug:this.settings.debug,container:a},b||{});try{c=new fr.ina.amalia.player.plugins.textSyncPlugin.Component(d)}catch(e){null!==this.logger&&this.logger.warn(e)}return c},updatePos:function(a){if(a=parseFloat(a),this.container.find(".line").removeClass("on"),this.container.find(".line").filter(function(b,c){return a>=Math.round(parseFloat($(c).attr("data-tcin")))&&a<Math.round(parseFloat($(c).attr("data-tcout")))}).addClass("on").each(function(b,c){c=$(c);var d=Math.round(parseInt($(c).attr("data-tcin"))),e=Math.round(parseInt($(c).attr("data-tcout"))),f=100*(Math.round(a)-d)/(e-d);c.find(".ajs-progress").show(),c.find(".ajs-progress-bar").css("width",Math.round(f)+"%")}),this.karaoke===!0){this.container.find(".word").removeClass("on");var b=this;this.container.find(".word").filter(function(c,d){return a>=parseFloat($(d).attr("data-tcin"))&&a<parseFloat($(d).attr("data-tcout"))+b.settings.karaokeOffsetTime}).addClass("on")}if(this.settings.autoScroll===!0){var c=this.container.find("li.line").eq(0).position(),d=this.container.find("li.line.on").position();c&&d&&this.container.stop().animate({scrollTop:d.top-c.top})}},createTitleBlock:function(a,b){var c=$("<div>",{"class":"header"}),d=$("<div>",{"class":"resume"}),e=$("<h3>",{"class":"heading",text:a});d.append(e);var f=$("<p>",{text:b});d.append(f),c.append(d),this.pluginContainer.append(c)},updateBlockData:function(){""!==this.settings.metadataId?(this.updateMetadata(this.settings.metadataId,this.settings.level,0,this.mediaPlayer.getDuration(),!0),this.updateListOfDisplayItems(this.settings.displayLevel)):""!==this.selectedMetadataId&&(this.updateMetadata(this.selectedMetadataId,this.settings.level,0,this.mediaPlayer.getDuration(),!0),this.updateListOfDisplayItems(this.settings.displayLevel))},onClickTc:function(a,b){b.hasOwnProperty("tc")===!0&&b.tc!==!0&&a.data.self.mediaPlayer.setCurrentTime(parseFloat(b.tc))},onSeek:function(a,b){var c=parseFloat(b.currentTime),d=a.data.self.container.find("li.line").eq(0).position(),e=a.data.self.container.find("li.line").filter(function(a,b){return c>=Math.round(parseFloat($(b).attr("data-tcin")))&&c<Math.round(parseFloat($(b).attr("data-tcout")))}).first().position();e&&d&&a.data.self.container.stop().animate({scrollTop:e.top-d.top},1500,"easeInOutExpo")},onSelectedMetadataChange:function(a,b){""===a.data.self.settings.metadataId&&null!==b.metadataId&&(a.data.self.selectedMetadataId=b.metadataId.toString(),a.data.self.updateBlockData()),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onSelectedMetadataChange id:"+b.metadataId)},onBeginDataChange:function(a){a.data.self.loadDataStarted=!0,null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"onBeginDataChange")},onDataChange:function(a){a.data.self.loadDataStarted===!1&&a.data.self.updateBlockData()},onEndDataChange:function(a){a.data.self.loadDataStarted=!1,a.data.self.updateBlockData(),null!==a.data.self.logger&&a.data.self.logger.trace(a.data.self.Class.fullName,"EndDataChange")}});